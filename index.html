<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Сбор патронов</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #222; touch-action: manipulation; }
        canvas { display: block; background: #228B22; }
        #controls {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 10;
        }
        .row { display: flex; }
        .btn {
            width: 60px; height: 60px;
            margin: 5px; font-size: 28px;
            text-align: center; line-height: 60px;
            border: 2px solid black; background: rgba(255, 255, 255, 0.7);
            border-radius: 10px;
            user-select: none; cursor: pointer;
        }
        #message {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 32px; font-weight: bold;
            color: white; background: rgba(0, 0, 0, 0.8);
            padding: 20px; border-radius: 10px;
            display: none;
        }
    </style>
</head>
<body>
<canvas id="gameCanvas"></canvas>
<div id="message">Все патроны собраны</div>
<div id="controls">
    <div class="btn" id="btn-up">↑</div>
    <div class="row">
        <div class="btn" id="btn-left">←</div>
        <div style="width: 60px;"></div>
        <div class="btn" id="btn-right">→</div>
    </div>
    <div class="btn" id="btn-down">↓</div>
</div>

<script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const message = document.getElementById("message");
    canvas.width = 1280;
    canvas.height = 1280;

    const cellSize = 80;
    let tank = { x: 8, y: 8, size: 20, speed: 20, dir: 'up' };
    let bullets = generateBullets(15);
    let movement = { up: false, down: false, left: false, right: false };
    let collectedBullets = 0;
    const baseLocation = { x: 15, y: 15 };

    function generateBullets(count) {
        let arr = [];
        while (arr.length < count) {
            let x = Math.floor(Math.random() * 16);
            let y = Math.floor(Math.random() * 16);
            if ((x !== 8 || y !== 8) && (x !== 15 || y !== 15)) {
                arr.push({ x, y });
            }
        }
        return arr;
    }

    function drawTank() {
        ctx.fillStyle = "black";
        let cx = tank.x * cellSize + cellSize / 2;
        let cy = tank.y * cellSize + cellSize / 2;

        ctx.save();
        ctx.translate(cx, cy);
        if (tank.dir === 'right') ctx.rotate(Math.PI / 2);
        if (tank.dir === 'down') ctx.rotate(Math.PI);
        if (tank.dir === 'left') ctx.rotate(-Math.PI / 2);

        ctx.fillRect(-tank.size / 2, -tank.size / 2, tank.size, tank.size);
        ctx.fillRect(-5, -15, 10, 10);
        ctx.restore();
    }

    function drawBullets() {
        ctx.fillStyle = "yellow";
        bullets.forEach(b => {
            let cx = b.x * cellSize + cellSize / 2;
            let cy = b.y * cellSize + cellSize / 2;
            ctx.beginPath();
            ctx.arc(cx, cy, 10, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = "black";
            ctx.stroke();
        });
    }

    function drawBase() {
        ctx.fillStyle = "gray";
        ctx.fillRect(baseLocation.x * cellSize, baseLocation.y * cellSize, cellSize, cellSize);
    }

    function checkCollisions() {
        bullets = bullets.filter(b => {
            if (b.x === tank.x && b.y === tank.y) {
                collectedBullets++;
                return false;
            }
            return true;
        });

        if (collectedBullets === 15 && tank.x === baseLocation.x && tank.y === baseLocation.y) {
            message.style.display = "block";
            setTimeout(resetGame, 10000);
        }
    }

    function moveTank() {
        if (movement.up && tank.y > 0) tank.y--;
        if (movement.down && tank.y < 15) tank.y++;
        if (movement.left && tank.x > 0) tank.x--;
        if (movement.right && tank.x < 15) tank.x++;
    }

    function update() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawBase();
        drawBullets();
        drawTank();
        checkCollisions();
        requestAnimationFrame(update);
    }

    function setMove(direction, state) {
        movement = { up: false, down: false, left: false, right: false };
        if (state) movement[direction] = true;
    }

    function resetGame() {
        collectedBullets = 0;
        bullets = generateBullets(15);
        tank.x = 8;
        tank.y = 8;
        message.style.display = "none";
    }

    document.getElementById("btn-up").addEventListener("touchstart", () => setMove('up', true));
    document.getElementById("btn-down").addEventListener("touchstart", () => setMove('down', true));
    document.getElementById("btn-left").addEventListener("touchstart", () => setMove('left', true));
    document.getElementById("btn-right").addEventListener("touchstart", () => setMove('right', true));

    document.getElementById("btn-up").addEventListener("touchend", () => setMove('up', false));
    document.getElementById("btn-down").addEventListener("touchend", () => setMove('down', false));
    document.getElementById("btn-left").addEventListener("touchend", () => setMove('left', false));
    document.getElementById("btn-right").addEventListener("touchend", () => setMove('right', false));

    Telegram.WebApp.ready();
    update();
</script>
</body>
</html>
